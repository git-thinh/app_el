<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="/css/ui.css" rel="stylesheet" />
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/w2ui/w2ui.min.js"></script>
    <link href="/js/w2ui/w2ui.min.css" rel="stylesheet" />
    <script src="/js/worker/underscore.min.js"></script>
</head>
<body>
    <div id="___module_id" style="position:absolute;width: 100%; height: 100vh;left:0;top:0;"></div>
    <script type="text/javascript">
        var api_host = 'http://localhost:3456';
        var ajax_get = function (url, event_ok, event_error) { var r = new XMLHttpRequest(); r.onreadystatechange = function () { if (this.readyState == 4 && this.status == 200) { if (event_ok != null) event_ok(JSON.parse(r.responseText)); } }; r.open("GET", url, true); r.send(); }
        var load = function (url) { var r = new XMLHttpRequest(); r.open('GET', url, false); r.send(null); if (r.status === 200) { return r.responseText; } return ''; }

        var ___module_id = {
            m_folder_prev: '',
            m_folder_current: '',
            m_path_root: '',
            m_path: '',
            m_item_current: null,
            m_items: [],
            m_inited: false,
            f_load_dir: function (m, path, folder) {
                if (path == null) path = '';
                if (folder == null) folder = '';

                var url = api_host + '?type=dir_get&path=' + path + '&folder=' + folder;
                console.log(url);

                var json = JSON.parse(load(url));
                var _path = json.path;
                if (_path[_path.length - 1] == '/') _path = _path.substring(0, _path.length - 1);

                ___module_id.m_path = _path;
                if (___module_id.m_path_root == '') ___module_id.m_path_root = _path;

                var dt = [];
                if (___module_id.m_path != ___module_id.m_path_root) {
                    /* is fetch subs folder */
                    dt.push({ recid: 0, type: 'dir', name: '...', title:'', count: '', date: '' });
                }

                var _count = json.dirs.length;
                Array.from(json.dirs).forEach(function (it, index) {
                    dt.push({ recid: index + 1, type: 'dir', name: it.dir, title: '', count: it.sum_file, date: '' });
                });
                Array.from(json.files).forEach(function (it, index) {
                    dt.push({ recid: _count + index + 1, type: 'file', name: it.file, title: it.title, count: it.sum_file, date: '' });
                });

                ___module_id.m_items = dt;

                //console.log(___module_id);

                w2ui[m.id].header = _path;
                w2ui[m.id].records = ___module_id.m_items;
                w2ui[m.id].refresh();
            },
            f_draw_grid: function (m) {

                $('#' + m.id).w2grid({
                    name: m.id,
                    show: {
                        header: true,  // indicates if header is visible
                        toolbar: true,  // indicates if toolbar is visible
                        footer: true,  // indicates if footer is visible
                        columnHeaders: true,   // indicates if columns is visible
                        lineNumbers: false,  // indicates if line numbers column is visible
                        expandColumn: false,  // indicates if expand column is visible
                        selectColumn: false,  // indicates if select column is visible
                        emptyRecords: true,   // indicates if empty records are visible
                        toolbarReload: true,   // indicates if toolbar reload button is visible
                        toolbarColumns: false,   // indicates if toolbar columns button is visible
                        toolbarSearch: true,   // indicates if toolbar search controls are visible
                        toolbarAdd: true,   // indicates if toolbar add new button is visible
                        toolbarEdit: true,   // indicates if toolbar edit button is visible
                        toolbarDelete: true,   // indicates if toolbar delete button is visible
                        toolbarSave: true,   // indicates if toolbar save button is visible
                        selectionBorder: true,   // display border around selection (for selectType = 'cell')
                        recordTitles: true,   // indicates if to define titles for records
                        skipRecords: true    // indicates if skip records should be visible
                    },
                    multiSearch: false,
                    reorderRows: true,
                    searches: [
                        { field: 'name', caption: 'Name', type: 'text' },
                        { field: 'title', caption: 'Title', type: 'text' }
                    ],
                    columns: [
                        { field: 'recid', caption: 'ID', size: '50px', sortable: true, attr: 'align=center' },
                        { field: 'type', caption: 'Type', size: '1%', sortable: true, resizable: true, hidden: true },
                        {
                            field: 'name', caption: 'Name', sortable: true, resizable: true, attr: "for=dir_file",
                            render: function (record, index, column_index) {
                                return '<div class=i-' + record.type + '>' + record.name + '</div>';
                            }
                        },
                        { field: 'title', caption: 'Title', size: '45%', sortable: true, resizable: true },
                        { field: 'count', caption: 'Count', size: '50px' },
                        { field: 'date', caption: 'Date', size: '60px' }
                    ],
                    onAdd: function (event) {
                        w2alert('add');
                    },
                    onEdit: function (event) {
                        w2alert('edit');
                    },
                    onDelete: function (event) {
                        console.log('delete has default behavior');
                    },
                    onSave: function (event) {
                        w2alert('save');
                    },
                    toolbar: {
                        items: [
                            { id: 'bt1', type: 'button', caption: 'Button 1', img: 'icon-folder' },
                            { id: 'bt2', type: 'button', caption: 'Button 2', img: 'icon-folder' },
                            { id: 'bt3', type: 'spacer' },
                            { id: 'bt4', type: 'button', caption: 'Reset', img: 'icon-page' },
                            { id: 'bt5', type: 'button', caption: 'Save', img: 'icon-page' }
                        ],
                        onClick: function (event) {
                            if (event.target == 'bt4') w2ui.form.clear();
                            if (event.target == 'bt5') w2ui.form.save();
                        }
                    },
                    records: [], //___module_id.m_items,
                    onDblClick: function (event) {
                        //console.log(event);
                        var id = parseInt(event.recid);
                        var its = _.filter(___module_id.m_items, function (it) { return it.recid == id; });
                        //console.log(its);
                        if (its != null && its.length > 0) {
                            var it = its[0];
                            if (it.name == '...') {
                                var a = ___module_id.m_path.split('/'),
                                    fol = a[a.length - 1],
                                    len = fol.length + 1,
                                    pt = ___module_id.m_path.substring(0, ___module_id.m_path.length - len);
                                ___module_id.f_load_dir(m, pt, '');
                            } else {
                                ___module_id.m_item_current = it;
                                if (it.type == 'dir') {
                                    var folder = it.name;
                                    ___module_id.f_load_dir(m, ___module_id.m_path, folder);
                                }
                            }
                        }
                    }
                });

                w2ui[m.id].on('*', function (event) {
                    if (event.type == 'resize' && ___module_id.m_inited == false) {
                        ___module_id.m_inited = true;
                        ___module_id.f_load_dir(m);
                    }
                });
            }
        };

        ___module_id.f_draw_grid({ id: '___module_id' });

    </script>

    <link href="/file.css" rel="stylesheet" />
</body>
</html>